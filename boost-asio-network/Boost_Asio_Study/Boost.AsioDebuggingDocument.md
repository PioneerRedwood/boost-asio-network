# Boost.AsioDebuggingDocument

ë²„ê·¸ë€, ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ í˜¹ì€ ëŸ°íƒ€ì„ ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” ì—ëŸ¬ë¥¼ ëª¨ë‘ í¬í•¨.

ë¨¸ë¦¿ì†ì˜ ìƒê°ë§Œìœ¼ë¡œ ëˆˆì— ë³´ì´ëŠ” í™”ë©´ë§Œìœ¼ë¡œ ëª¨ë“  ê²ƒì„ ì¶”ì í•  ìˆ˜ ì—†ë‹¤. ìƒê°ì„ ì •ë¦¬í•˜ê³  ê¸€ë¡œ ë‚¨ê¸°ë©° ë…¼ë¦¬ì ìœ¼ë¡œ ì¶”ë¡ í•˜ëŠ” ê²ƒì´ ë‚´ê²Œ ìˆì–´ì„œ í•„ìˆ˜ì ì„ì„ ìµœê·¼ì—ì„œì•¼ ì•Œê²Œ ëë‹¤.



## 2021-09-16 #1

#### ë¬¸ì œì  #1

- í˜„ì¬ ì—°ê²°ì€ ì›ê²© í˜¸ìŠ¤íŠ¸ì— ì˜í•´ ê°•ì œë¡œ ëŠê²¼ìŠµë‹ˆë‹¤
- í˜„ì¬ ì—°ê²°ì€ ì‚¬ìš©ìì˜ í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œì˜ ì†Œí”„íŠ¸ì›¨ì–´ì˜ ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤

```C++
// boost::asio::execution::any_executor.hpp ì¼ë¶€ë¶„
#if !defined(BOOST_ASIO_NO_TYPEID)
  const std::type_info& target_type() const
#else // !defined(BOOST_ASIO_NO_TYPEID)
  const void* target_type() const
#endif // !defined(BOOST_ASIO_NO_TYPEID)
  {
    return target_fns_->target_type(); // Access 
  }
```

ìœ„ëŠ” shared_ptrë¡œ ì„ ì–¸ëœ ê²ƒì˜ ì ‘ê·¼í•  ìˆ˜ ì—†ëŠ” ë¶€ë¶„ì„ ì ‘ê·¼í•˜ë ¤ê³  ì‹œë„í–ˆì„ë•Œ ë°œìƒí•˜ëŠ” ëŸ°íƒ€ì„ì—ëŸ¬ì¸ë° boost-asio-network-server/clientì—ì„œ êµ¬í˜„í–ˆì„ ë•ŒëŠ” í…Œí¬ë‹ˆì»¬ ë„ì„œì—ì„œ ì°¸ê³ í–ˆë˜ ë§¤í¬ë¡œë¥¼ ë– ì˜¬ë ¸ë‹¤. 

```c++
#define BIND(x)				boost::bind(&self_type::x, shared_from_this())
class connection
{ ...  public using self_type = connection; ... }
```

í•´ë‹¹ ë§¤í¬ë¡œëŠ” ì¸ìë¡œ xë¥¼ ë°›ëŠ”ë° ì´ê²ƒì€ í•¨ìˆ˜ í¬ì¸í„°ì´ë©° boost::bind() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤. bind í•¨ìˆ˜ì—ì„œ ì£¼ëª©í•´ì•¼í•  ë¶€ë¶„ì€ ë°”ë¡œ ë‘ë²ˆì§¸ ì¸ìì¸ë° shared_ptrë¡œ ìƒì„±ëœ í´ë˜ìŠ¤ì˜ í•¨ìˆ˜ë¥¼ ë‹¤ë£¨ê¸° ìœ„í•´ì„  thisë¥¼ ì‚¬ìš©í•  ë•Œ ì£¼ì˜ë¥¼ ê¸°ìš¸ì—¬ì•¼ í•œë‹¤. ìœ„ ì—‘ì„¸ìŠ¤ ìœ„ë°˜ ì—ëŸ¬ê°€ ìƒê²¨ë‚œ ì›ì¸ì€ ë°”ë¡œ ì•„ë˜ ì½”ë“œì´ë‹¤. 

```
void async_read(socket_, boost::asio::buffer(read_buffer_),
	// completion condition
	[this](const err& error, size_t bytes) -> bool {
		if (error) { return 0; }
		bool found = std::find(read_buffer_, read_buffer_ + bytes, '\n') 
			< read_buffer_ + bytes;
		return found ? 0 : 1;
	},
	// handler			
	boost::bind(&connection::on_read, this, _1, _2)); 				// Unexpected ERROR!
	boost::bind(&connection::on_read, shared_from_this(), _1, _2)); // OK!
```

ì¶”ê°€ë¡œ boost::async í•¨ìˆ˜ë“¤ì— ëŒë‹¤ í•¨ìˆ˜ë¥¼ ì½œë°±í•¨ìˆ˜ë¡œ ë“±ë¡í•  ìˆ˜ ìˆë‹¤. ëŒë‹¤ í´ë¡œì € ë‚´ì—ì„œ í´ë˜ìŠ¤ ë©¤ë²„ì— ì ‘ê·¼í•  ìˆ˜ëŠ” ìˆì–´ë„ shared_ptrë¡œ ì„ ì–¸ëœ ìƒíƒœë¼ë©´ thisë¥¼ ì“°ëŠ” ê²ƒì€ ì˜ˆìƒí•  ìˆ˜ ì—†ëŠ” ê²°ê³¼ë¥¼ ì´ˆë˜í•œë‹¤. ëŒë‹¤ë¥¼ ë³´ê¸°ì— ê¹”ë”í•˜ë‹¤ëŠ” ì´ìœ ë¡œ ì‚¬ìš©í–ˆì§€ë§Œ ë””ë²„ê¹…ë„ í˜ë“¤ ë¿ë”ëŸ¬ ë‚˜ì¤‘ì—” ì˜¤íˆë ¤ ìˆ˜ì •í•˜ëŠ” ë°ì—ë„ ì–´ë ¤ì›€ì´ ìˆì—ˆë‹¤. 

ì°¸ê³ ë¡œ í˜„ì¬ í•´ë‹¹ ë§¤í¬ë¡œëŠ” ì“°ì§€ ì•Šì„ ì˜ˆì •ì´ë‹¤.



**2021-09-29 ëŒë‹¤ì— ëŒ€í•œ ìƒˆë¡œìš´ ìƒê° ì¶”ê°€**

- C++ ëŒë‹¤ì— ëŒ€í•´ì„œ ì •í™•í•œ ì‹ê²¬ì´ ì—†ì–´ì„œ ì „ì— ì´ëŸ¬í•œ ì–´ë ¤ì›€ì„ ê²ªì—ˆë‹¤. ì—¬ëŸ¬ ê¸€ì„ ì°¸ê³ í•˜ê³  Effective Modern C++ ë„ì„œ([í•´ë‹¹ ë„ì„œì˜ pdf ì›¹ íŒŒì¼](https://moodle.ufsc.br/pluginfile.php/2377667/mod_resource/content/0/Effective_Modern_C__.pdf))ë¥¼ ì°¸ê³ í•œ ê²°ê³¼. ëŒë‹¤ë¥¼ ì˜ ì•Œê³  ì‚¬ìš©í•˜ë©´ ì½”ë“œ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì— ìˆì–´ì„œ ë§ì€ ì´ì ì„ ê°€ì ¸ë‹¤ì¤„ ìˆ˜ ìˆìŒì„ í›„ì—ì„œì•¼ ì•Œê²Œëë‹¤.
- í•˜ì§€ë§Œ ìœ„ ë§¥ë½ì— ìˆì–´ì„œ ë””ë²„ê¹…ì´ ì–´ë ¤ì› ë˜ ë¶€ë¶„ì€ ì‚¬ì‹¤ì´ì—ˆê¸° ë•Œë¬¸ì— ê¸€ì„ ì§€ìš°ì§€ ì•Šê³  ì°¸ê³ í˜•ì‹ìœ¼ë¡œ ì¶”ê°€í•˜ëŠ”ê²Œ ë§ˆë•…í•˜ë‹¤ê³  ìƒê°í–ˆë‹¤.

```c++
void accept()
{
    //boost::shared_ptr<connection> conn_ = boost::make_shared<connection>(
    //	context_, recv_deque_, curr_id_, conn_map_, rooms_);
    // 
    //acceptor_.async_accept(
    //	boost::bind(&server::on_accept, this, boost::asio::placeholders::error, conn_));

    acceptor_.async_accept(
        [this](const boost::system::error_code& error, boost::asio::ip::tcp::socket socket)
        {
            if (!error)
            {
                std::cout << "new connection: " << socket.remote_endpoint() << "\n";

                boost::shared_ptr<connection> conn_ = boost::make_shared<connection>(
                    context_, recv_deque_, curr_id_, std::move(socket), conn_map_, rooms_);

                conn_map_.insert(std::make_pair(curr_id_++, conn_));
                conn_->start();

                std::cout << "[SERVER] connected clients ";
                for (const auto iter : conn_map_)
                {
                    std::cout << iter.first << " ";
                }
                std::cout << "\n";
            }
            else
            {
                std::cerr << "[SERVER] ERROR " << error.message() << "\n";
                return;
            }
            accept();
        });
}
```



#### ë¬¸ì œì  #2

- boost::asio::io_contextë¥¼ ì„œë²„/í´ë¼ì´ì–¸íŠ¸ í´ë˜ìŠ¤ ë©¤ë²„ ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ê³  ì‹¤í–‰í•˜ë©´ ë¹„ì •ìƒ ì¢…ë£Œë˜ëŠ” ë²„ê·¸

- ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì§€ë§Œ í´ë¼ì´ì–¸íŠ¸ê°€ ì œëŒ€ë¡œ ë°›ì§€ ëª»í•˜ëŠ” ë²„ê·¸
  - ì—°ê²°ì´ ì•ˆë¼ìˆìœ¼ë©´ ì•„ì˜ˆ í†µì‹ ì„ í•  ìˆ˜ ì—†ìœ¼ë©° ë‹¤ë¥¸ ë²„ê·¸ë¡œ í‘œì‹œë¼ì•¼í•¨

```c++
size_t on_read_completion(const err& error, size_t bytes)
{
    if (error) { return 0; }
	// char* std::find(char* First, char* Last, const char& Val)
    // First ~ Last ë‚´ì—ì„œ Val ê°’ì˜ ìœ„ì¹˜(charí˜• í¬ì¸í„°)ë¥¼ ë°˜í™˜
    // ì½ì–´ì˜¨ ë°ì´í„° ì•ˆì— Valì´ í¬í•¨ë¼ìˆë‹¤ë©´ true ì•„ë‹ˆë©´ false
    // trueëŠ” ì½ê¸°ë¥¼ ë§ˆì¹œ ìƒíƒœë¥¼ ì˜ë¯¸, falseëŠ” ë°˜ëŒ€
    bool found = std::find(read_buffer_, read_buffer_ + bytes, '\n') 
        < read_buffer_ + bytes;
    return found ? 0 : 1;
}

void read()
{
	if (socket_.is_open())
	{
        // ì½ê¸° ì „ ë²„í¼ ì´ˆê¸°í™”
		std::fill_n(read_buffer_, MAX_MSG, '\0');
		async_read(socket_, boost::asio::buffer(read_buffer_),
			boost::bind(&connection::on_read_completion, shared_from_this(), _1, _2),
			boost::bind(&connection::on_read, shared_from_this(), _1, _2));

		//socket_.async_read_some(boost::asio::buffer(read_buffer_, MAX_MSG),
		//	boost::bind(&connection::on_read_completion, shared_from_this(), _1, _2),
		//	boost::bind(&connection::on_read, shared_from_this(), _1, _2));
	}
}
```

ì„œë²„, í´ë¼ì´ì–¸íŠ¸ ì–‘ì¸¡ì—ì„œ ê³µë™ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì†Œì¼“ìœ¼ë¡œë¶€í„° ë¹„ë™ê¸° ì½ê¸° ì‹¤í–‰ ë¶€ë¶„ì´ë‹¤. ì„œë²„ì˜ ì‹œê·¸ë‹ˆì²˜ë¥¼ ì„¤ëª…í•˜ì§„ ì•Šê² ë‹¤. async_readì˜ 3ë²ˆì§¸ , async_read_some 2ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜ëŠ” ì§€ê¸ˆê¹Œì§€ ì½ì–´ì˜¨ ë‚´ìš© ì¤‘ ì–´ëŠ ì¡°ê±´ì— ë¶€í•©í•˜ëŠ”ì§€ ì²˜ë¦¬í•˜ëŠ” ì™„ë£Œ í•¨ìˆ˜(í…Œí¬ë‹ˆì»¬ ë„ì„œì—ì„  completion function ìœ¼ë¡œ ì†Œê°œë¨)ë‹¤. ì¶”ê°€ë¡œ ì™„ë£Œ í•¨ìˆ˜ëŠ” ì„ íƒì‚¬í•­ì´ë‹¤.

- async_read ì—ì„œ EOF 
  - ì°¾ì§€ ëª»í•¨
  - 2021-09-29 ì¶”ê°€ ì˜ˆìƒì¹˜ ëª»í•œ ë¹„ë™ê¸° ì½ê¸° ì¢…ë£Œì‹œ ë°œìƒí•˜ëŠ” ì—ëŸ¬



## 2021-09-29 #2

#### ë¬¸ì œì  #1

- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡ ì‘ì—…ì´ ìˆ˜í–‰ì´ ë˜ê³  ì„œë²„ì—ì„  ë°›ì€ ë©”ì‹œì§€ë¥¼ ì½˜ì†”ì— ì¶œë ¥í•œë‹¤. ê·¸ ì¦‰ì‹œ ì„œë²„ëŠ” ë°›ì€ ë©”ì‹œì§€ì— ë”°ë¼ í´ë¼ì´ì–¸íŠ¸ì— ì ì ˆí•œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤. 
- ì—¬ê¸°ì„œ ì„œë²„ë¡œë¶€í„° ìˆ˜ì‹ ëœ ë©”ì‹œì§€ì˜ í˜•íƒœê°€ ë§¤ìš° ì´ìƒí•˜ë‹¤.

#### ë””ë²„ê¹…

- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìˆ˜ì‹ ëœ ë©”ì‹œì§€ë¥¼ ì½ëŠ” ë¶€ë¶„ì—ì„œëŠ” on_read_completion()ì´ë¼ëŠ” í•¨ìˆ˜ë¡œ "\n" ë¬¸ìê°€ ì˜¬ ë•Œê¹Œì§€ ì½ëŠ”ë°, ë¬´ì‘ìœ„ë¡œ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ë‹¤ê°€ ì„œë²„ì—ì„œ ë¹„ë™ê¸° ì“°ê¸° í•¨ìˆ˜ì—ì„œ ë³´ë‚´ëŠ” ë‚´ìš© ëì— "\n" ë¬¸ìë¥¼ ë¶™ì´ëŠ” ê²ƒì„ ì‚­ì œí–ˆë‹¤. 



#### ~~ë¬¸ì œì  #2~~

- ~~ì„¤ê³„ìƒ í´ë¼ì´ì–¸íŠ¸ëŠ” í‚¤ë³´ë“œ ì…ë ¥ì— ë”°ë¼ ì„œë²„ì— ì „ì†¡í•˜ëŠ” ë©”ì‹œì§€ê°€ ë‹¤ë¥´ë‹¤. ì„œë²„ì—ì„œ ìˆ˜ì‹ ì€ ë¹ ë¥¸ë° ë‹¤ì‹œ ëŒì•„ì˜¤ëŠ” ì‘ë‹µì—ëŠ” ë”œë ˆì´ê°€ ìˆë‹¤.~~

#### ~~ë¬¸ì œì  #3~~

- ~~í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ì´ 5-6ê°œ ëì„ ë•Œ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ë¡œ ì¸í•´ ì¢…ë£Œë  ìˆ˜ ìˆë‹¤.~~



#### ë¬¸ì œì  #4

- ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ì–‘ìª½ ëª¨ë‘ boost::asio::io_context(ì´í•˜ io_context) ì¸ìŠ¤í„´ìŠ¤ì˜ run() í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•  ìŠ¤ë ˆë“œë¥¼ ì–´ë””ì— ë§Œë“œëŠ”ê²Œ ì í•©í• ê¹Œ?
  - í˜„ì¬ ë°©ì‹ì—ì„œ ì„œë²„ëŠ” ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” main í•¨ìˆ˜ì—ì„œ io_context ê°ì²´ë¥¼ ì°¸ì¡° ì „ë‹¬í•´ì„œ ìƒì„±í•˜ì—¬ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ë‚´ë¶€ì— ìˆëŠ” ìŠ¤ë ˆë“œë¡œ ì°¸ì¡° ì „ë‹¬ëœ io_context ê°ì²´ì˜ run()ì„ í˜¸ì¶œí•œë‹¤. í´ë¼ì´ì–¸íŠ¸ ì—­ì‹œ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ìˆ˜í–‰í•˜ì§€ë§Œ í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” ë¬´í•œ ë£¨í”„ë¡œ ì—°ê²°ì´ ì¢…ë£Œë˜ê¸°ê¹Œì§€ ì‚¬ìš©ìì˜ í‚¤ë³´ë“œ ì…ë ¥ì— ë”°ë¼ ì„œë²„ì— ë°ì´í„°ë¥¼ ì „ì†¡í•œë‹¤. 
  - ê³§ë°”ë¡œ ì¢…ë£Œë¨, io_contextì˜ ì°¸ì¡°ê°€ ì „ë‹¬ëœ boost::asio::steady_timerê°€ ìˆëŠ”ë°ë„ ì¢…ë£Œë¨

#### ë””ë²„ê¹…

- ì„œë²„ëŠ” ì¢…ë£Œë˜ê³  í´ë¼ì´ì–¸íŠ¸ëŠ” ì¢…ë£Œë˜ì§€ ì•ŠëŠ” ì´ìœ ëŠ” ê·¸ ë‘˜ì˜ ì°¨ì´ì ì— ìˆë‹¤. í´ë¼ì´ì–¸íŠ¸ëŠ” main í•¨ìˆ˜ ë‚´ì— ì¼ì • ì¡°ê±´ì— ì˜í•´ ëë‚˜ëŠ” ë¬´í•œ ë£¨í”„ ì‘ì—…ì´ ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì— ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë˜ì§€ ì•ŠëŠ”ë‹¤.
- io_contextê°€ ì¡´ì¬í•˜ëŠ” main ë‚´ì—ì„œ ë”ì´ìƒì˜ ì‘ì—…ì´ ì—†ëŠ” ê²½ìš° main ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë˜ë©´ì„œ í”„ë¡œê·¸ë¨ ë‚´ ìŠ¤ë ˆë“œëŠ” ëª¨ë‘ ì¢…ë£Œëœë‹¤. ì´ë¡œ ì¸í•´ ì„œë²„ëŠ” ì•„ë¬´ë¦¬ io_contextì— ë¹„ë™ê¸° í˜¸ì¶œì´ ì¡´ì¬í•œë‹¤í•´ë„ ì¢…ë£Œë˜ëŠ” ê²ƒì´ë‹¤.



#### ë¬¸ì œì  #5

- ì„œë²„/í´ë¼ì´ì–¸íŠ¸ì˜ ì†Œì¼“ ë° ë²„í¼ ë˜í¼ í´ë˜ìŠ¤ì¸ connectionì—ì„œ on_message() ë‚´ë¶€ì—ì„œ ìˆ˜ì‹ ëœ ë©”ì‹œì§€ë¥¼ 1ì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•´ì„œ ìˆ˜ì‹  ë©”ì‹œì§€ ë±ì— ì €ì¥í•˜ê³  ì¼ì • ì£¼ê¸°ë§ˆë‹¤ ìˆ˜ì‹  ë±ì„ ì ê²€í•˜ëŠ” ì„œë²„/í´ë¼ì´ì–¸íŠ¸ì˜ update()ì—ì„œ 2ì°¨ì ìœ¼ë¡œ  ì²˜ë¦¬í•œë‹¤.
- ê³¼ì—° ì´ êµ¬ì¡°ê°€ í•©ë¦¬ì ì¼ê¹Œ? ì „ë¬¸ê°€ì—ê²Œ ë¬¼ì–´ë³´ì



#### ë¬¸ì œì  #6

- í˜„ì¬ ì„œë²„ ì¸¡ì— ì„¸ì…˜ ë£¸ ìƒì„± ìš”ì²­ ì‹œ ì²˜ë¦¬í•˜ëŠ” ê³¼ì •ì—ì„œ ì—‘ì„¸ìŠ¤ ìœ„ë°˜ ì˜ˆì™¸ë¥¼ ë§ˆì£¼í–ˆë‹¤. - std::unique_ptr ì‚¬ìš©ìœ¼ë¡œ í•´ê²°í–ˆìœ¼ë‚˜ ì„¤ê³„ê°€ ì—¬ì „íˆ ë§ˆìŒì— ì•ˆë“¬
- ì„¸ì…˜ ë£¸ì„ ìƒì„±í•˜ê³  ë‚˜ì„œ ì¡°íšŒê¹Œì§€ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ ì„¸ì…˜ì„ ì†Œìœ í•˜ê³  ìˆëŠ” í´ë¼ì´ì–¸íŠ¸ ì¢…ë£Œì‹œ ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ê¹Œì§€ ì¢…ë£Œí•˜ëŠ” ë²„ê·¸ ë°œê²¬



## 2021-09-30 #3

connection -ìƒì†-> server_connection/client_connection êµ¬ì¡° ë¦¬íŒ©í† ë§

ê·œì¹™

- ëŒë‹¤ ì ê·¹ ì‚¬ìš©
- ìƒì† êµ¬ì¡°ì¸ë§Œí¼ ì¤‘ë³µë˜ëŠ” ì½”ë“œ ìˆ˜ ìµœëŒ€í•œ ì ˆê°

#### ë””ë²„ê¹… #1

- boost::make_sharedì—ì„œ socketì„ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬í•  ë•Œ boost::asio::basic_stream_socketì€ ë³µì‚¬ì™€ í• ë‹¹ì„ í—ˆìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì´ë™ ì—°ì‚° std::move()ì„ ì‚¬ìš©í•´ ì „ë‹¬í•œë‹¤.



#### ë¬¸ì œì  #1

- connection read/write ë¶€ë¶„ì´ ëŒë‹¤ë¥¼ ì‚¬ìš©í•˜ë©´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤. ìƒì„¸í•œ ì—ëŸ¬ëŠ” ë‹¤ì‹œ ë‹¤ë£° ì˜ˆì •

```c++
// std <memory>
...
void _Incwref() noexcept { // increment weak reference count
        _MT_INCR(_Weaks);
    }
...
```



## 2021-10-01 #4

##### 2021-09-30 #3-1 ë¬¸ì œì  ë””ë²„ê¹… 

í™•ì‹¤í•˜ì§€ ì•Šìœ¼ë‚˜ ì—¬ëŸ¬ê°€ì§€ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ê³  ë””ë²„ê¹…í•œ ê²°ê³¼ .. ì´ê²¬ì´ ìƒê¸¸ ê²½ìš° ì¶”ê°€í•  ì˜ˆì •

```C++
async_read(socket_, boost::asio::buffer(read_buffer_),        
    // connection ì¸ìŠ¤í„´ìŠ¤ì˜ ë‚´ìš©ë§Œ ì°¸ê³ í•˜ë©´ ë˜ê¸° ë•Œë¬¸ì— shared_ptrëŠ” í•„ìš” ì—†ìŒ
    // ì˜ë¬¸ì . ìµœì í™”ë©´ì—ì„œ connection ì¸ìŠ¤í„´ìŠ¤ì˜ ë³µì‚¬ëŠ” ë¹„íš¨ìœ¨ì ì´ë‹¤. 
    // ë§Œì•½ ì°¸ì¡°ë¡œ shared_ptrëœ ê±¸ ë„˜ê¸°ë©´ ë³´ë‹¤ íš¨ìœ¨ì ì¼ê¹Œ?
	[this](const err& error, size_t bytes)->size_t
	{
		if (error) { return 0; }
		bool found = std::find(read_buffer_, read_buffer_ + bytes, '\n') < read_buffer_ + bytes;
		return found ? 0 : 1;
	},
    // lambda captureì— ì‹ì„ ì¶”ê°€í•´ì„œ shared_ptr ì „ë‹¬
	[this, self = std::move(this->shared_from_this())](const err& error, size_t bytes)->void
	{
		if (!started_) { return; }
		if (error)
		{
			std::cout << "[ERROR] async_read\n" << error.message() << "\n";
			return;
		}
		std::string msg(read_buffer_, bytes);
        // shared ì¸ìŠ¤í„´ìŠ¤ê°€ í•„ìš”í•œ ë¶€ë¶„
		self->on_message(msg);
	});
```

ë§Œì•½ thisë¥¼ ì¸ìë¡œ ë„˜ê¸°ë©´ connectionì„ ë³µì‚¬ ìƒì„±ì„ í•˜ê²Œ ë˜ê³  shared_ptrì˜ ê°•í•œ ì°¸ì¡° íšŸìˆ˜(strong reference count)ë¥¼ ì¦ê°€ì‹œí‚¤ì§€ ì•Šê³  ì•½í•œ ì°¸ì¡° íšŸìˆ˜(weak reference count)ë¥¼ ì¦ê°€ì‹œí‚¨ë‹¤. shared ì¸ìŠ¤í„´ìŠ¤ê°€ í•„ìš”í•œ ë¶€ë¶„ì¸ self->on_message(msg)ì—ì„œëŠ” ë³µì‚¬ ìƒì„±í•œ ì¸ìŠ¤í„´ìŠ¤ê°€ ì•„ë‹ˆë¼ ì‹¤ì œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¸ì¡°í•´ì•¼ í•œë‹¤. 

ì¶”ì‹ 

- ìœ„ ì„¤ëª…ì´ ë§¤ë„ëŸ½ì§€ ì•Šì€ë° ì •í™•í•œ ì´ìœ ë¥¼ ëª¨ë¥´ê² ë‹¤. ê·¸ì € ì—ëŸ¬ê°€ ë°œìƒí•œ ë¶€ë¶„ìœ¼ë¡œë¶€í„°ì˜ ì¶”ì¸¡ì¼ ë¿ì´ë‹¤.

- ì§§ì€ ì˜ì–´ë¡œ stackoverflowì— [ë¬¸ì˜](https://stackoverflow.com/questions/69400540/c-boost-asio-network-in-async-callback-which-one-is-better-using-lambda-or/69400604#69400604)ë¥¼ ì˜¬ë¦¬ê³  ìŠ¤ìŠ¤ë¡œ ë‹µí–ˆë‹¤. ğŸ¤¦â€â™‚ï¸



#### ë¬¸ì œì  #1

- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì ‘ì†í•œ ë’¤ í†µì‹  ì¤‘ ê°‘ì‘ìŠ¤ëŸ½ê²Œ ì ‘ì†ì´ ì¢…ë£Œëœë‹¤.
